<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
  background-color: #f8f9fa;
}

/* Sidebar */
.sidebar {
  width: 150px;
  height: 100vh;
  overflow-y: auto;
  position: sticky;
  top: 0;
  background-color: #051922;
  border-right: 1px solid #033047;
  transition: all 0.3s ease;
}

.sidebar h5 {
  color: #F28123;
  position: sticky;
  top: 0;
  z-index: 2;
  background-color: #051922;
  padding: 0.75rem;
  border-bottom: 1px solid #033047;
}

.sidebar .list-group-item {
  background-color: #051922;
  color: white;
  border: none;
  transition: color 0.3s ease, background-color 0.3s ease;
}

.sidebar .list-group-item:hover {
  background-color: #F28123;
  color: #051922;
}

.sidebar .list-group-item.active {
  background-color: #F28123;
  color: #051922;
  font-weight: 600;
}

/* Hide scrollbar */
.sidebar::-webkit-scrollbar {
  display: none;
}

/* Mobile header */
.mobile-header {
  background-color: #051922;
  border-bottom: 1px solid #033047;
}

/* Hamburger button (3 bars) */
#menu-toggle {
  border: none;
  background: none;
  width: 30px;
  height: 24px;
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  cursor: pointer;
  padding: 0;
}
#menu-toggle::before,
#menu-toggle::after,
#menu-toggle span {
  content: '';
  display: block;
  height: 3px;
  width: 100%;
  background-color: white;
  border-radius: 2px;
  transition: all 0.3s ease;
}
#menu-toggle.active::before {
  transform: translateY(9px) rotate(45deg);
  background-color: orange;
}
#menu-toggle.active::after {
  transform: translateY(-9px) rotate(-45deg);
  background-color: orange;
}
#menu-toggle.active span {
  background-color: transparent;
}

/* Main area */
main {
  flex: 1;
  padding: 2rem;
  background-color: #F28123;
  min-height: 100vh;
}

/* Chart area */
canvas {
  width: 100% !important;
  height: 300px !important;
}

/* ---------- Responsive ---------- */
@media (max-width: 991.98px) {
  .sidebar {
    width: 130px;
  }
}
@media (max-width: 767.98px) {
  .sidebar {
    width: 100%;
    height: auto;
    position: relative;
    border-right: none;
    border-bottom: 1px solid #033047;
    display: none;
  }
  .sidebar.show {
    display: block;
  }
  main {
    padding: 1rem !important;
  }
}
@media (max-width: 575.98px) {
  .sidebar .list-group-item {
    text-align: center;
  }
}
@media (max-width: 767.98px) {
  .row.g-4 > [class*="col-"] {
    flex: 0 0 100%;
    max-width: 100%;
  }
}


  </style>
</head>

<body>
  <!-- Header (Mobile) -->
<!-- Header (Visible only on small screens) -->
<header class="mobile-header d-flex justify-content-between align-items-center p-2 d-md-none">
  <h5 class="mb-0 text-light">My Admin</h5>
  <button id="menu-toggle"><span></span></button>
</header>

<div class="d-flex flex-column flex-md-row">
  <!-- Sidebar -->
  <aside class="sidebar border-end" id="sidebar">
    <h5 class="p-3 border-bottom d-none d-md-block"><%= admin ? admin.name.split(' ')[0] : 'Admin' %></h5>
    <nav class="list-group list-group-flush">
      <a href="/admin" class="list-group-item list-group-item-action active">Dashboard</a>
      <a href="/admin/orders" class="list-group-item list-group-item-action">Orders</a>
      <a href="/admin/products" class="list-group-item list-group-item-action">Products</a>
      <a href="/admin/customers" class="list-group-item list-group-item-action">Customers</a>
      <a href="/admin/analytics" class="list-group-item list-group-item-action">Analytics</a>
      <a href="/admin/coupons" class="list-group-item list-group-item-action">Coupons</a>
      <a href="/admin/settings" class="list-group-item list-group-item-action">Settings</a>
      <a href="/admin/support" class="list-group-item list-group-item-action">Support</a>
      <a href="/admin/profile" class="list-group-item list-group-item-action">Profile</a>
    </nav>
  </aside>

    <!-- Main Content -->
    <main>
      <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
        <h3 class="fw-bold">Dashboard Overview</h3>
        <div class="d-flex gap-2">
          <select id="timeFilter" class="form-select">
            <option value="weekly">Weekly</option>
            <option value="monthly" selected>Monthly</option>
            <option value="yearly">Yearly</option>
          </select>
          <button id="downloadPDF" class="btn text-white" style="background-color:#F28123;">Download PDF</button>
        </div>
      </div>

      <!-- Revenue Growth Charts -->
    <div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center">
    <h5>Sales Overview</h5>
    <select id="rangeSelect" class="form-select w-auto">
      <option value="week">This Week</option>
      <option value="month">This Month</option>
      <option value="year">This Year</option>
    </select>
  </div>
  <canvas id="salesChart" height="120"></canvas>
</div>

        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">Sales by Category (Pie Chart)</div>
            <div class="card-body">
              <canvas id="pieChart"></canvas>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">Weekly/Monthly/Yearly Revenue (Bar Chart)</div>
            <div class="card-body">
              <canvas id="barChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  // --- helper & state ---
  const timeFilter = document.getElementById('timeFilter');
  const downloadBtn = document.getElementById('downloadPDF');

  let lineChart = null;
  let barChart = null;
  let pieChart = null;

  // Map UI select value -> backend range param
  const rangeMap = {
    'weekly': 'week',
    'monthly': 'month',
    'yearly': 'year'
  };

  // Fallback sample data if backend fails (so charts still render)
  const FALLBACK = {
    weekly: { labels: ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"], data: [500,800,700,900,600,1100,950] },
    monthly: { labels: ["Day 1","Day 2","Day 3","Day 4","Day 5","Day 6"], data: [4000,5200,4900,6100,7200,6700] },
    yearly: { labels: ["2021","2022","2023","2024","2025"], data: [54000,58000,60000,75000,89000] }
  };

  // Fetch sales data from backend
  async function fetchSales(rangeKey) {
    const range = rangeMap[rangeKey] || 'week';
    try {
      const res = await fetch(`/admin?range=${range}`, { credentials: 'same-origin' });
      if (!res.ok) throw new Error('fetch failed ' + res.status);
      const json = await res.json();
      // Expecting { labels: [...], data: [...] }
      if (!json || !Array.isArray(json.labels) || !Array.isArray(json.data)) {
        throw new Error('unexpected payload');
      }
      return json;
    } catch (err) {
      console.warn('fetchSales failed, using fallback:', err);
      return FALLBACK[rangeKey] || FALLBACK.monthly;
    }
  }

  // Create or update charts with given labels/data
  function updateCharts(labels, data) {
    const ctxLine = document.getElementById("lineChart").getContext("2d");
    const ctxBar = document.getElementById("barChart").getContext("2d");
    const ctxPie = document.getElementById("pieChart").getContext("2d");

    // Destroy existing to avoid duplicates
    if (lineChart) lineChart.destroy();
    if (barChart) barChart.destroy();
    if (pieChart) pieChart.destroy();

    // Line Chart (Revenue)
    lineChart = new Chart(ctxLine, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "Revenue (₹)",
          data,
          borderColor: "#F28123",
          backgroundColor: "rgba(242,129,35,0.15)",
          fill: true,
          tension: 0.3,
          pointRadius: 3,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { callback: v => '₹' + v }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => `₹ ${ctx.parsed.y ?? ctx.parsed}`
            }
          }
        }
      }
    });

    // Bar Chart (same data)
    barChart = new Chart(ctxBar, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "Revenue (₹)",
          data,
          backgroundColor: "#F28893"
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    // Pie Chart (static categories for now)
    pieChart = new Chart(ctxPie, {
      type: "pie",
      data: {
        labels: ["Apples", "Bananas", "Mangoes", "Oranges", "Grapes"],
        datasets: [{
          data: [25, 20, 15, 30, 10],
          // Chart.js will pick default colors; explicit colors are optional
        }]
      },
      options: { responsive: true }
    });
  }

  // Load & render for the selected period
  async function loadAndRender(periodKey) {
    // show temporary "loading" state on button
    downloadBtn.disabled = true;
    downloadBtn.textContent = 'Loading...';

    const payload = await fetchSales(periodKey);
    updateCharts(payload.labels, payload.data);

    // restore download button
    downloadBtn.disabled = false;
    downloadBtn.textContent = 'Download PDF';
  }

  // init
  (function init() {
    // initial render using the select default
    loadAndRender(timeFilter.value || 'monthly');

    // change listener
    timeFilter.addEventListener('change', (e) => loadAndRender(e.target.value));
  })();

  // PDF download uses existing html2canvas + jsPDF code; keep it
  document.getElementById("downloadPDF").addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "mm", "a4");
    const dashboard = document.querySelector("main");
    const canvas = await html2canvas(dashboard, { scale: 1.5 });
    const imgData = canvas.toDataURL("image/png");
    const imgWidth = 190;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    pdf.addImage(imgData, "PNG", 10, 10, imgWidth, imgHeight);
    pdf.save(`Revenue_Report_${timeFilter.value}.pdf`);
  });
</script>


  <script>
  const toggleBtn = document.getElementById('menu-toggle');
  const sidebar = document.getElementById('sidebar');

  toggleBtn.addEventListener('click', () => {
    sidebar.classList.toggle('show');
    toggleBtn.classList.toggle('active');
  });
</script>
<script>
async function loadChart(range = 'week') {
  const res = await fetch(`/admin?range=${range}`);
  const { labels, data } = await res.json();

  if (window.salesChart) window.salesChart.destroy(); // destroy old instance

  const ctx = document.getElementById('salesChart').getContext('2d');
  window.salesChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Total Sales (₹)',
        data,
        borderColor: 'rgba(75,192,192,1)',
        backgroundColor: 'rgba(75,192,192,0.2)',
        tension: 0.3,
        fill: true,
        borderWidth: 2,
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: value => '₹' + value
          }
        }
      }
    }
  });
}

document.getElementById('rangeSelect').addEventListener('change', e => {
  loadChart(e.target.value);
});

loadChart(); // initial load
</script>
</body>
</html>
