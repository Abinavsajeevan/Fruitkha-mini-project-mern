<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
  background-color: #f8f9fa;
}

/* Sidebar */
.sidebar {
  width: 150px;
  height: 100vh;
  overflow-y: auto;
  position: sticky;
  top: 0;
  background-color: #051922;
  border-right: 1px solid #033047;
  transition: all 0.3s ease;
}

.sidebar h5 {
  color: #F28123;
  position: sticky;
  top: 0;
  z-index: 2;
  background-color: #051922;
  padding: 0.75rem;
  border-bottom: 1px solid #033047;
}

.sidebar .list-group-item {
  background-color: #051922;
  color: white;
  border: none;
  transition: color 0.3s ease, background-color 0.3s ease;
}

.sidebar .list-group-item:hover {
  background-color: #F28123;
  color: #051922;
}

.sidebar .list-group-item.active {
  background-color: #F28123;
  color: #051922;
  font-weight: 600;
}

/* Hide scrollbar */
.sidebar::-webkit-scrollbar {
  display: none;
}

/* Mobile header */
.mobile-header {
  background-color: #051922;
  border-bottom: 1px solid #033047;
}

/* Hamburger button (3 bars) */
#menu-toggle {
  border: none;
  background: none;
  width: 30px;
  height: 24px;
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  cursor: pointer;
  padding: 0;
}
#menu-toggle::before,
#menu-toggle::after,
#menu-toggle span {
  content: '';
  display: block;
  height: 3px;
  width: 100%;
  background-color: white;
  border-radius: 2px;
  transition: all 0.3s ease;
}
#menu-toggle.active::before {
  transform: translateY(9px) rotate(45deg);
  background-color: orange;
}
#menu-toggle.active::after {
  transform: translateY(-9px) rotate(-45deg);
  background-color: orange;
}
#menu-toggle.active span {
  background-color: transparent;
}

/* Main area */
main {
  flex: 1;
  padding: 2rem;
  background-color: #F28123;
  min-height: 100vh;
}

/* Chart area */
canvas {
  width: 100% !important;
  height: 300px !important;
}

/* ---------- Responsive ---------- */
@media (max-width: 991.98px) {
  .sidebar {
    width: 130px;
  }
}
@media (max-width: 767.98px) {
  .sidebar {
    width: 100%;
    height: auto;
    position: relative;
    border-right: none;
    border-bottom: 1px solid #033047;
    display: none;
  }
  .sidebar.show {
    display: block;
  }
  main {
    padding: 1rem !important;
  }
}
@media (max-width: 575.98px) {
  .sidebar .list-group-item {
    text-align: center;
  }
}
@media (max-width: 767.98px) {
  .row.g-4 > [class*="col-"] {
    flex: 0 0 100%;
    max-width: 100%;
  }
}


  </style>
</head>

<body>
  <!-- Header (Mobile) -->
<!-- Header (Visible only on small screens) -->
<header class="mobile-header d-flex justify-content-between align-items-center p-2 d-md-none">
  <h5 class="mb-0 text-light">My Admin</h5>
  <button id="menu-toggle"><span></span></button>
</header>

<div class="d-flex flex-column flex-md-row">
  <!-- Sidebar -->
  <aside class="sidebar border-end" id="sidebar">
    <h5 class="p-3 border-bottom d-none d-md-block"><%= admin ? admin.name.split(' ')[0] : 'Admin' %></h5>
    <nav class="list-group list-group-flush">
      <a href="/admin" class="list-group-item list-group-item-action active">Dashboard</a>
      <a href="/admin/orders" class="list-group-item list-group-item-action">Orders</a>
      <a href="/admin/products" class="list-group-item list-group-item-action">Products</a>
      <a href="/admin/customers" class="list-group-item list-group-item-action">Customers</a>
      <a href="/admin/analytics" class="list-group-item list-group-item-action">Analytics</a>
      <a href="/admin/coupons" class="list-group-item list-group-item-action">Coupons</a>
      <a href="/admin/settings" class="list-group-item list-group-item-action">Settings</a>
      <a href="/admin/support" class="list-group-item list-group-item-action">Support</a>
      <a href="/admin/profile" class="list-group-item list-group-item-action">Profile</a>
    </nav>
  </aside>

    <!-- Main Content -->
    <main>
      <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
        <h3 class="fw-bold">Dashboard Overview</h3>
        <div class="d-flex gap-2">
          <select id="timeFilter" class="form-select">
            <option value="week">Weekly</option>
            <option value="month" selected>Monthly</option>
            <option value="year">Yearly</option>
          </select>

          <button id="downloadPDF" class="btn text-white" style="background-color:#F28123;">Download PDF</button>
        </div>
      </div>

            <!-- Quick Stats -->
      <div class="row g-4 mb-4">
        <div class="col-sm-6 col-lg-3">
          <div class="card stat-card shadow-sm text-center p-3">
            <h5 class="text-success">Total Revenue</h5>
              <h3 id="totalRevenue">₹0</h3>
            <p class="text-muted mb-0" id="totalCount">0+ orders placed</p>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card stat-card shadow-sm text-center p-3">
            <h5 class="text-primary">Pending</h5>
            <h3 id="pendingAmount">₹0</h3>
            <p class="text-muted mb-0" id="pendingCount">0+ orders pending</p>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card stat-card shadow-sm text-center p-3">
            <h5 class="text-warning">Recieved</h5>
            <h3 id="receivedAmount">₹0</h3>
            <p class="text-muted mb-0" id="receivedCount">0+ orders received</p>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card stat-card shadow-sm text-center p-3">
            <h5 class="text-danger">Cancelled</h5>
            <h3 id="cancelledAmount">₹0</h3>
            <p class="text-muted mb-0" id="cancelCount">0+ orders cancelled</p>
          </div>
        </div>
      </div>

      <!-- Revenue Growth Charts -->
      <div class="row g-4">

        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">Revenue Growth (Line Chart)</div>
              <div class="card-body">
                <canvas id="lineChart"></canvas>
            </div>
          </div>
        </div>


        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">Sales by Category (Pie Chart)</div>
            <div class="card-body">
              <canvas id="pieChart"></canvas>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header bg-dark text-white"> Revenue (Bar Chart)</div>
            <div class="card-body">
              <canvas id="barChart"></canvas>
            </div>
          </div>
        </div> 
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
  const toggleBtn = document.getElementById('menu-toggle');
  const sidebar = document.getElementById('sidebar');

  toggleBtn.addEventListener('click', () => {
    sidebar.classList.toggle('show');
    toggleBtn.classList.toggle('active');
  });
</script>
<!-- stats -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const timeFilter = document.getElementById("timeFilter");

    async function fetchStats(range = 'month') {
      const res = await fetch(`/admin/stats?range=${range}`, {
        headers: { "Accept": 'application/json' }
      });

      if(!res.ok) {
        console.error("Failed to fetch stats", res.status);
        return null;
      }
      return res.json();
    }

    function formatCurrency(x) {
      if (x === null) return '₹0';
      //it just make format only 
      return '₹' + Number(x).toLocaleString("en-IN");
    }

    async function  renderStats(range = 'month') {
      const stats = await fetchStats(range);
      if(!stats) return 

       document.getElementById("totalRevenue").textContent    = formatCurrency(stats.totalRevenue);
    document.getElementById("pendingAmount").textContent   = formatCurrency(stats.pendingAmount);
    document.getElementById("receivedAmount").textContent  = formatCurrency(stats.receivedAmount);
    document.getElementById("cancelledAmount").textContent = formatCurrency(stats.cancelledAmount);
     document.getElementById("totalCount").textContent    = stats.totalCount + '+ orders placed';
    document.getElementById("pendingCount").textContent   = stats.pendingCount + '+ orders pending'
    document.getElementById("receivedCount").textContent  = stats.receivedCount + '+ orders received'
    document.getElementById("cancelCount").textContent = stats.cancelCount + '+ orders cancelled'
    }

    renderStats('month');
  timeFilter.addEventListener("change", (e) => {
      renderStats(e.target.value);
    });
  })
</script>

<!-- charts  -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const ctx = document.getElementById("lineChart").getContext("2d");
    const timeFilter = document.getElementById("timeFilter");

    let chart;

    async function fetchRevenueData(range = "month") {
      const res = await fetch(`/admin/revenue-data?range=${range}`);
      const data = await res.json();
      return data;
    }

    async function renderChart(range = "month") {
      const { labels, revenues } = await fetchRevenueData(range);

      if (chart) chart.destroy(); // reset previous chart

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Total Revenue",
            data: revenues,
            borderColor: "#051922",
            backgroundColor: "rgba(242,129,35,0.3)",
            tension: 0.4,
            fill: true,
            pointBackgroundColor: "#F28123",
            pointRadius: 5
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: value => "₹" + value
              }
            }
          }
        }
      });
    }

    // Initial render
    renderChart("month");

    // Filter change
    timeFilter.addEventListener("change", (e) => {
      renderChart(e.target.value);
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const pieCtx = document.getElementById("pieChart").getContext("2d");
      const timeFilter = document.getElementById("timeFilter");

    let pieChart;

    async function fetchPieData(range = 'month') {
      const res = await fetch(`/admin/pie-data?range=${range}`);
      const data = await res.json();
      return data;
    }

    async function renderPieChart(range) {
      const { labels, data } = await fetchPieData(range);

      if(pieChart) pieChart.destroy();

      pieChart = new Chart(pieCtx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: [
            '#F28123',
            '#051922',
            '#FF6384',
            '#36A2EB',
            '#FFCE56',
            '#8AFF33',
            '#33FFF5',
            '#FF33D1'
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: '#051922', font: { size: 14 } }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.label}: ${context.raw} kg sold`;
              }
            }
          }
        }
      }
      })
    }

      renderPieChart("month");

  // Filter change
  timeFilter.addEventListener("change", (e) => {
    renderPieChart(e.target.value);
  });
  })
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const barCtx = document.getElementById("barChart").getContext("2d");
    const timeFilter = document.getElementById("timeFilter");

    let barChart;
    async function fetchBarData(range = 'month') {
      const res = await fetch(`/admin/bar-data?range=${range}`);
      const data = await res.json();
      return data;
    }

    async function renderBarChart(range = 'month') {
      const { labels, revenues } = await fetchBarData(range);

      if(barChart) barChart.destroy()
      barChart = new Chart(barCtx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "Revenue by Category",
          data: revenues,
          backgroundColor: [
            "#F28123",
            "#051922",
            "#FF6384",
            "#36A2EB",
            "#FFCE56",
            "#8AFF33",
            "#33FFF5",
            "#FF33D1"
          ],
          borderColor: "#051922",
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: value => "₹" + value
            }
          },
          x: {
            ticks: {
              color: "#051922",
              font: { size: 13 }
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: context => `Revenue: ₹${context.raw}`
            }
          }
        }
      }
    });
  }

  renderBarChart("month");

  // Re-render when filter changes
  timeFilter.addEventListener("change", (e) => {
    renderBarChart(e.target.value);
  });
  })
</script>


</body>
</html>
